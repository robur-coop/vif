<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>My first Vif application - Vif, a simple webserver in OCaml</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Vif, a simple webserver in OCaml</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="my-first-vif-application"><a class="header" href="#my-first-vif-application">My first Vif application</a></h1>
<p>To understand Vif, we will iterate several times on a small project whose goal
is to implement a website with a user area. This goal will allow us to see the
main features of Vif. To do this, we will also use <code>hurl</code>, an HTTP client in
OCaml that uses the same libraries as Vif. The latter will allow us to inspect
a whole host of details regarding requests, responses and cookies.</p>
<p>Let's start by installing <code>vif</code> and <code>hurl</code> using <code>opam</code>. Next, we will create a
folder and work in it to develop our brand new website.</p>
<pre><code class="language-shell">$ opam install vif
$ opam install hurl
$ mkdir my-first-vif-application
$ cd my-first-vif-application
</code></pre>
<p>Vif is a library, but we also offer a small program that allows you to run an
OCaml script and launch an HTTP server. This approach has the advantage of
avoiding the "development, compilation, testing" loop (as is the case with
native languages) and focusing primarily on development and testing.</p>
<p>We will come back to the <code>vif</code> tool, the library and the different ways of using
this project in more detail later, but for now let's focus on developing our
website.</p>
<h2 id="my-first-webpage-with-vif"><a class="header" href="#my-first-webpage-with-vif">My first webpage with Vif</a></h2>
<p>We are therefore going to create an OCaml script in which we will develop our
website:</p>
<pre><code class="language-shell">$ cat &gt;main.ml &lt;&lt;EOF
#require "vif" ;;

let () = Miou_unix.run @@ fun () -&gt; Vif.run [] () ;;
EOF
$ vif --pid vif.pid main.ml &amp;
$ hurl http://localhost:8080/
HTTP/1.1 404 Not Found

connection: close
content-length: 120
content-length: 120
content-type: text/plain; charset=utf-8

Unspecified destination / (GET):
user-agent: hurl/0.0.1
host: localhost
connection: close
content-length: 0
$ kill -SIGINT $(cat vif.pid)
</code></pre>
<p>Here, we write a new file called <code>main.ml</code>, which will simply launch the
<a href="https://github.com/robur-coop/miou">Miou</a> scheduler and the Vif server. We then run this script using <code>vif</code>
and make an HTTP request using <code>hurl</code> to obtain a response. Finally, we <code>kill</code>
the Vif server.</p>
<p>The Vif server responded with a 404 (<em>not found</em>) response because no routes are
defined, and it also describes the request it just received. We will therefore
add a route for our website.</p>
<pre><code class="language-ocaml">#require "vif" ;;

let index req _server () =
  let open Vif.Response.Syntax in
  let str = "Hello World!\n" in
  let* () = Vif.Response.add ~field:"content-type" "text/plain; charset=utf-8" in
  let* () = Vif.Response.with_string req str in
  Vif.Response.respond `OK
;;

let routes =
  let open Vif.Uri in
  let open Vif.Route in
  [ get (rel /?? any) --&gt; index ]
;;

let () = Miou_unix.run @@ fun () -&gt;
  Vif.run routes () ;;
</code></pre>
<pre><code class="language-shell">$ vif --pid vif.pid main.ml &amp;
$ hurl https://localhost:8080/
HTTP/1.1 200 OK

connection: close
content-length: 13
content-type: text/plain; charset=utf-8

Hello World!
$ kill -SIGINT $(cat vif.pid)
</code></pre>
<p>And here is our first page with Vif! We have added a new <code>index</code> function that
will process the request and provide a response. In this response, we will
write <code>"Hello World!"</code> and send it with the code 200 (<code>`OK</code>). We can see
that this is indeed what the server responds when we use <code>hurl</code>.</p>
<p>This <code>index</code> function will be associated with a route <code>get (rel /?? any)</code>. This
route allows us to filter requests and specify that the <code>index</code> function will
only process GET requests with the path <code>"/"</code>.</p>
<h2 id="routes"><a class="header" href="#routes">Routes</a></h2>
<p>The principle behind routes is fairly simple to understand: it allows you to
associate (<code>--&gt;</code>) a path on your website with a function that will process the
request and respond. What Vif brings to the table is the ability to <em>type</em>
routes. Another frequently requested route feature is the ability to specify
<em>holes</em> in the path, which would be values provided by the user.</p>
<p>For example, we would like a route in which the user could specify the name:</p>
<pre><code class="language-ocaml">#require "vif" ;;

let hello req (name : string) _server () =
  let open Vif.Response.Syntax in
  let str = Fmt.str "Hello %S!\n" name in
  let* () = Vif.Response.add ~field:"content-type" "text/plain; charset=utf-8" in
  let* () = Vif.Response.with_string req str in
  Vif.Response.respond `OK
;;

let user req (uid : int) _server () =
  let open Vif.Response.Syntax in
  let str = Fmt.str "User %d!\n" uid in
  let* () = Vif.Response.add ~field:"content-type" "text/plain; charset=utf-8" in
  let* () = Vif.Response.with_string req str in
  Vif.Response.respond `OK
;;

let routes =
  let open Vif.Uri in
  let open Vif.Route in
  [ get (rel / "hello" /% string `Path /?? any) --&gt; hello
  ; get (rel / "user" /% int /?? any) --&gt; user ]
;;

let () = Miou_unix.run @@ fun () -&gt;
  Vif.run routes () ;;
</code></pre>
<pre><code class="language-shell">$ hurl http://localhost:8080/hello/robur -p b
Hello "robur"!
$ hurl http://localhost:8080/user/42 -p b
User 42!
$ hurl http://localhost:8080/user/robur -p b
Unspecified destination /user/robur (GET):
...
</code></pre>
<p>As we can see, it is possible to define "holes" in our routes with Vif and
obtain their value in the functions associated with these routes. It is also
possible to <em>type</em> these holes so that you only process a certain type of
information, such as an integer (as is the case for our second <code>user</code> function).
Vif will then not only recognise integers, but also transform the value into a
real OCaml integer that you can manipulate.</p>
<p>It is possible to define more complex "holes" that must match a regular
expression. Here is an example where we would like to recognise certain fruits
in our route.</p>
<pre><code class="language-ocaml">#require "vif" ;;

type fruit =
  | Apple
  | Orange
  | Banana
;;

let pp ppf = function
  | Apple -&gt; Fmt.string ppf "Apple"
  | Orange -&gt; Fmt.string ppf "Orange"
  | Banana -&gt; Fmt.string ppf "Banana"
;;

let fruit =
  let v = Tyre.regex Re.(alt [ str "apple"; str "orange"; str "banana" ]) in
  let inj = function
    | "apple" -&gt; Apple
    | "orange" -&gt; Orange
    | "banana" -&gt; Banana
    | _ -&gt; assert false in
  let prj = function
    | Apple -&gt; "apple"
    | Orange -&gt; "orange"
    | Banana -&gt; "banana" in
  Vif.Uri.conv inj prj v
;;

let like req (fruit : fruit) _server () =
  let open Vif.Response.Syntax in
  let str = Fmt.str "I like %a!\n" pp fruit in
  let* () = Vif.Response.add ~field:"content-type" "text/plain; charset=utf-8" in
  let* () = Vif.Response.with_string req str in
  Vif.Response.respond `OK
;;

let routes =
  let open Vif.Uri in
  let open Vif.Route in
  [ get (rel /% fruit /?? any) --&gt; like ]
;;

let () = Miou_unix.run @@ fun () -&gt;
  Vif.run routes () ;;
</code></pre>
<pre><code class="language-shell">$ hurl http://localhost:8080/orange -p b
I like Orange!
$ hurl http://localhost:8080/cherries -p b
Unspecified destination /cherries (GET):
...
</code></pre>
<p>Here we describe how to recognise certain fruits using a regular expression
(and thanks to the <a href="https://github.com/ocaml/re"><code>re</code></a> library). Next, we describe how to convert
recognised strings into OCaml values (<code>inj</code> ). Finally, we use this new value in
our route in order to recognise only the specified fruits.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next steps</a></h2>
<p>At this point, you should have a basic understanding of how routes work with
Vif. The next step is to create our user space. This essentially consists of
two routes:</p>
<ul>
<li>a route for submitting user credentials to the server</li>
<li>a route reserved for logged-in users</li>
</ul>
<p>First, we will focus on the server-side mechanics of credential verification.
These credentials will initially be submitted using JSON.</p>
<p>Next, we will introduce the concept of cookies and middleware, which will allow
us to create our second route (accessible only to logged-in users).</p>
<p>Finally, we will enhance this foundation with other features offered by Vif.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="my_basic_userspace.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="my_basic_userspace.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
